#!/bin/bash
set -e

: '
–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–¥ –∏–∑ Git
- –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
- –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç Gunicorn
- –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è
'

# -------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
# -------------------------------
PROJECT_DIR="/home/dmitry/www/tehkonig.ru"
GIT_BRANCH="main"
VENV_DIR="$PROJECT_DIR/.venv"
SERVICE_NAME="tehkonig_site.service"
LOG_FILE="$PROJECT_DIR/logs/deploy_server.log"

mkdir -p "$PROJECT_DIR/logs"

# -------------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -------------------------------
timestamp() {
    date +"%F %T"
}

log() {
    echo "[$(timestamp)] $*" | tee -a "$LOG_FILE"
}

cd "$PROJECT_DIR"

# -------------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
# -------------------------------
log "üåê –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ Git..."
git fetch origin
git reset --hard origin/$GIT_BRANCH
# –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã, –∏—Å–∫–ª—é—á–∞—è –≤–∞–∂–Ω—ã–µ –ø–∞–ø–∫–∏
git clean -fd -e .venv -e logs -e staticfiles -e media -e .git
git pull origin $GIT_BRANCH

# -------------------------------
# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
# -------------------------------
if [ ! -d "$VENV_DIR" ]; then
    log "üì¶ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞—ë–º..."
    python3 -m venv "$VENV_DIR"
fi

log "‚ö° –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source "$VENV_DIR/bin/activate"

# -------------------------------
# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# -------------------------------
log "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install --upgrade pip
if [ -f "$PROJECT_DIR/requirements.txt" ]; then
    pip install -r requirements.txt
else
    log "‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
fi

# -------------------------------
# –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏–∫–∞
# -------------------------------
mkdir -p staticfiles media

# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º exit-on-error –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –∏ —Å—Ç–∞—Ç–∏–∫–∏
set +e

log "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
python manage.py migrate
if [ $? -ne 0 ]; then log "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏—è—Ö"; fi

log "üìÅ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É..."
python manage.py collectstatic --noinput
if [ $? -ne 0 ]; then log "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —Å—Ç–∞—Ç–∏–∫–∏"; fi

# –í–∫–ª—é—á–∞–µ–º exit-on-error –æ–±—Ä–∞—Ç–Ω–æ
set -e

# -------------------------------
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Gunicorn
# -------------------------------
log "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Gunicorn..."
sudo systemctl restart $SERVICE_NAME


log "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–≤–µ—Ä—à—ë–Ω!"

